<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Clean up your forScore library. Fix composer names, standardize formatting, and tidy metadata — all in your browser.">
    <meta property="og:title" content="TidyScore">
    <meta property="og:description" content="Clean up your forScore library. Fix composer names, standardize formatting, and tidy metadata — all in your browser.">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="TidyScore">
    <meta name="twitter:description" content="Clean up your forScore library. Fix composer names, standardize formatting, and tidy metadata — all in your browser.">
    <title>TidyScore</title>
    <link rel="stylesheet" href="src/styles/index.css">
</head>
<body>
    <header class="app-header">
        <div class="app-header-inner">
            <div class="app-brand">
                <svg class="app-logo" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 6v16c0 .6-.4 1-1 1H9.5C7.6 23 6 21.7 6 20s1.6-3 3.5-3c.9 0 1.7.3 2.5.8V6z" fill="rgba(255,255,255,0.9)"/>
                    <path d="M12 6l8-3v12" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round"/>
                    <path d="M20 15v2c0 .6-.4 1-1 1h-1.5c-1.9 0-3.5-1.3-3.5-3s1.6-3 3.5-3c.9 0 1.7.3 2.5.8V3" fill="rgba(255,255,255,0.9)"/>
                    <circle cx="24" cy="6" r="1.5" fill="#6dd4e0"/>
                    <circle cx="27" cy="10" r="1" fill="#6dd4e0" opacity="0.7"/>
                    <circle cx="25" cy="3" r="1" fill="#6dd4e0" opacity="0.5"/>
                </svg>
                <div>
                    <div class="app-title">TidyScore</div>
                    <div class="app-tagline">Clean up your forScore library</div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <button class="settings-btn" onclick="app.openSettingsModal()" aria-label="Open settings" aria-haspopup="dialog" aria-controls="settingsModal">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="10" cy="10" r="3"/>
                        <path d="M16.6 12a1 1 0 0 0 .2 1.1l.1.1a1.2 1.2 0 0 1 0 1.7l-.1.1a1.2 1.2 0 0 1-1.7 0l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V16a1.2 1.2 0 0 1-1.2 1.2h-.2A1.2 1.2 0 0 1 10.7 16v-.2a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a1.2 1.2 0 0 1-1.7 0l-.1-.1a1.2 1.2 0 0 1 0-1.7l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H6a1.2 1.2 0 0 1-1.2-1.2v-.2A1.2 1.2 0 0 1 6 9.1h.2a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1a1.2 1.2 0 0 1 0-1.7l.1-.1a1.2 1.2 0 0 1 1.7 0l.1.1a1 1 0 0 0 1.1.2h0a1 1 0 0 0 .6-.9V4a1.2 1.2 0 0 1 1.2-1.2h.2A1.2 1.2 0 0 1 13.1 4v.2a1 1 0 0 0 .6.9h0a1 1 0 0 0 1.1-.2l.1-.1a1.2 1.2 0 0 1 1.7 0l.1.1a1.2 1.2 0 0 1 0 1.7l-.1.1a1 1 0 0 0-.2 1.1v0a1 1 0 0 0 .9.6h.2A1.2 1.2 0 0 1 19 9.3v.2a1.2 1.2 0 0 1-1.2 1.2h-.2a1 1 0 0 0-.9.6Z"/>
                    </svg>
                    <span>Settings</span>
                </button>
                <button class="help-btn" onclick="app.showHelp()" aria-label="How it works">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="10" cy="10" r="8"/>
                        <path d="M7.5 7.5a2.5 2.5 0 0 1 4.5 1.5c0 1.5-2 2-2 3.5"/>
                        <circle cx="10" cy="15" r="0.5" fill="currentColor" stroke="none"/>
                    </svg>
                </button>
                <button class="theme-toggle" onclick="app.toggleTheme()" aria-label="Toggle dark mode">
                    <svg class="theme-icon theme-icon--light" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                        <circle cx="10" cy="10" r="4"/>
                        <path d="M10 2v2M10 16v2M2 10h2M16 10h2M4.2 4.2l1.4 1.4M14.4 14.4l1.4 1.4M4.2 15.8l1.4-1.4M14.4 5.6l1.4-1.4"/>
                    </svg>
                    <svg class="theme-icon theme-icon--dark" width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
                        <path d="M17 11.5a7 7 0 0 1-9.5-9.5A7 7 0 1 0 17 11.5z"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="uploadSection" class="upload-section">
            <div class="upload-icon">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="8" y="4" width="24" height="32" rx="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M14 22h12M14 28h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M32 18v20a3 3 0 0 1-3 3H13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M36 28l-4-4-4 4M32 24v12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="upload-text">Drop your forScore CSV file here or click to browse</div>
            <div class="upload-hint">Not sure where your CSV file is? Click 'How Does this Work' below.</div>
            <input type="file" id="fileInput" accept=".csv">
        </div>
        <div id="samplePrompt" class="sample-prompt">
            or <a href="#" class="sample-link" onclick="event.preventDefault(); app.loadSample();">try with sample data</a> to explore the tools
        </div>
        <div id="helpLink" class="help-link">
            <a href="#" onclick="event.preventDefault(); app.showHelp();">How does this work?</a> &mdash; step-by-step setup guide
        </div>
        <div id="privacyNote" class="privacy-note">
            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="7" width="8" height="7" rx="1"/><path d="M5.5 7V5a2.5 2.5 0 0 1 5 0v2"/></svg>
            Your data never leaves your browser
        </div>

        <div id="statsSection" class="hidden">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--scores">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                            <path d="M8 4v10c0 1.7-1.3 3-3 3s-3-1.3-3-3 1.3-3 3-3c.7 0 1.4.2 2 .6V4l8-2v10c0 1.7-1.3 3-3 3s-3-1.3-3-3 1.3-3 3-3c.7 0 1.4.2 2 .6V2"/>
                        </svg>
                    </div>
                    <div class="stat-label">Total Scores</div>
                    <div class="stat-value" id="totalScores">0</div>
                </div>
                <div class="stat-card stat-card--clickable" onclick="app.toggleComposerStats(event)" id="composerStatCard">
                    <div class="stat-icon stat-icon--composers">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                            <circle cx="10" cy="6" r="3"/>
                            <path d="M3 18c0-3.9 3.1-7 7-7s7 3.1 7 7"/>
                        </svg>
                    </div>
                    <div class="stat-label">Unique Composers</div>
                    <div class="stat-value" id="uniqueComposers">0</div>
                    <div id="composerStatsDropdown" class="stat-dropdown hidden"></div>
                </div>
                <div class="stat-card stat-card--clickable" onclick="app.toggleModifiedStats(event)" id="modifiedStatCard">
                    <div class="stat-icon stat-icon--modified">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12.5 2.5l5 5L7 18H2v-5L12.5 2.5z"/>
                        </svg>
                    </div>
                    <div class="stat-label">Modified</div>
                    <div class="stat-value" id="modifiedCount">0</div>
                    <div id="modifiedStatsDropdown" class="stat-dropdown hidden"></div>
                </div>
            </div>
        </div>

        <div id="tableSection" class="table-section hidden">
            <div class="section-header">
                <h2>Your Library</h2>
                <span id="scopeIndicator" class="scope-indicator"></span>
            </div>
            
            <div id="bulkControls" class="bulk-controls">
                <span class="bulk-label"><span id="selectedCount">0</span> selected</span>
                <button class="btn btn-secondary btn-sm" onclick="app.clearSelection()">Clear</button>
            </div>

            <div class="search-wrapper">
                <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <circle cx="7" cy="7" r="5"/><path d="M11 11l4 4"/>
                </svg>
                <input type="text" id="searchInput" class="search-input" placeholder="Search...">
                <button id="searchClear" class="search-clear hidden" onclick="app.clearSearch()">&times;</button>
            </div>
            <span id="rowCountIndicator" class="row-count-indicator" aria-live="polite"></span>

            <div class="mobile-sort">
                <label for="mobileSortSelect">Sort by:</label>
                <select id="mobileSortSelect" onchange="app.mobileSortChanged(this.value)">
                    <option value="">Default order</option>
                    <option value="title-asc">Title A-Z</option>
                    <option value="title-desc">Title Z-A</option>
                    <option value="composer-asc">Composer A-Z</option>
                    <option value="composer-desc">Composer Z-A</option>
                    <option value="genre-asc">Genre A-Z</option>
                    <option value="genre-desc">Genre Z-A</option>
                    <option value="tags-asc">Tags A-Z</option>
                    <option value="tags-desc">Tags Z-A</option>
                </select>
            </div>

            <div class="scan-results-panel" aria-label="Scan results">
                <div class="scan-results-header">
                    <div>
                        <div class="scan-results-title">Scan results</div>
                        <div class="scan-results-subtitle">Start with these quick fixes, then use advanced tools below.</div>
                    </div>
                </div>
                <div class="scan-results-list">
                    <div class="scan-result-row">
                        <div class="scan-result-meta">
                            <span id="scanCountMissingComposer" class="scan-count-badge">0</span>
                            <div class="scan-result-copy">
                                <div class="scan-result-label">Missing/incomplete composers</div>
                                <div class="scan-result-desc">Fills blank composer fields by inferring from the title, and completes partial names.</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm scan-fix-btn" onclick="app.runScanFix('missingComposer')">Fix composers</button>
                    </div>
                    <div class="scan-result-row">
                        <div class="scan-result-meta">
                            <span id="scanCountVariantComposer" class="scan-count-badge">0</span>
                            <div class="scan-result-copy">
                                <div class="scan-result-label">Inconsistent composer formatting</div>
                                <div class="scan-result-desc">Finds names that can be standardized to a consistent composer format.</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm scan-fix-btn" onclick="app.runScanFix('composerFormatting')">Standardize composer names</button>
                    </div>
                    <div class="scan-result-row">
                        <div class="scan-result-meta">
                            <span id="scanCountImslpTitles" class="scan-count-badge">0</span>
                            <div class="scan-result-copy">
                                <div class="scan-result-label">Titles with file-name junk (IMSLP IDs, underscores)</div>
                                <div class="scan-result-desc">Spots IMSLP IDs, underscores, and imported filename artifacts in titles.</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm scan-fix-btn" onclick="app.runScanFix('imslpTitles')">Fix titles</button>
                    </div>
                </div>
            </div>

            <div class="table-controls">
                <button class="btn btn-secondary btn-tool" onclick="app.smartExtract()">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M2 14L14 2"/><circle cx="5" cy="2" r="1" fill="currentColor" stroke="none"/><circle cx="14" cy="10" r="1" fill="currentColor" stroke="none"/><circle cx="10" cy="5" r="0.7" fill="currentColor" stroke="none"/></svg>
                    <span class="btn-tool-label">Smart Extract</span>
                    <span class="btn-tool-desc">Find and correct incomplete composer names</span>
                </button>
                <button class="btn btn-secondary btn-tool" onclick="app.standardizeComposers()">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M3 3h10M3 8h7M3 13h4"/><path d="M13 8v6l2-2M13 14l-2-2"/></svg>
                    <span class="btn-tool-label">Standardize</span>
                    <span id="standardizeToolDesc" class="btn-tool-desc">Apply Last, First name format to composers</span>
                </button>
                <button class="btn btn-secondary btn-tool" onclick="app.findReplace()">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><circle cx="6" cy="6" r="4"/><path d="M9 9l4 4"/></svg>
                    <span class="btn-tool-label">Find & Replace</span>
                    <span class="btn-tool-desc">Search and edit in bulk</span>
                </button>
                <button class="btn btn-secondary btn-tool" onclick="app.cleanImslpTitles()">
                    <svg width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 14l3-6h4l3 6H3zM8 8V2M5 5h6"/></svg>
                    <span class="btn-tool-label">Clean IMSLP</span>
                    <span class="btn-tool-desc">Simplify imported titles</span>
                </button>
                <div class="btn-tool-wrapper">
                    <button id="genreTagMenuTrigger" class="btn btn-secondary btn-tool" onclick="app.toggleGenreTagMenu(event)" aria-expanded="false" aria-controls="genreTagDropdown">
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 2h6l2 2h5a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2z"/>
                            <path d="M5 9h6M5 12h3"/>
                        </svg>
                        <span class="btn-tool-label">More Tools</span>
                        <span class="btn-tool-desc">Genre, tags & cleanup</span>
                        <svg class="btn-tool-menu-caret" width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M4 6l4 4 4-4"/>
                        </svg>
                    </button>
                    <div id="genreTagDropdown" class="tool-dropdown">
                        <button class="tool-dropdown-item" onclick="app.quickClean()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2l1 3 3 1-3 1-1 3-1-3-3-1 3-1 1-3z"/><path d="M11 8l.7 2 2 .7-2 .7-.7 2-.7-2-2-.7 2-.7.7-2z"/></svg>
                            <div>
                                <div>Quick Clean</div>
                                <div class="tool-dropdown-item-desc">Minor formatting cleanup</div>
                            </div>
                        </button>
                        <button class="tool-dropdown-item" onclick="app.suggestGenres()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h12M2 7h8M2 11h5"/><circle cx="12" cy="10" r="3"/><path d="M12 9v2M11 10h2"/></svg>
                            <div>
                                <div>Suggest Genre</div>
                                <div class="tool-dropdown-item-desc">Fill genre from composer era</div>
                            </div>
                        </button>
                        <button class="tool-dropdown-item" onclick="app.suggestTags()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 3l4-1v12l-4 1V3z"/><path d="M5 2l5-1v12l-5 1V2z"/><path d="M13 8l2 2-2 2"/></svg>
                            <div>
                                <div>Suggest Tags</div>
                                <div class="tool-dropdown-item-desc">Detect tags from title keywords</div>
                            </div>
                        </button>
                        <button class="tool-dropdown-item" onclick="app.openBatchTagEditor()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4h12M2 8h12M2 12h12"/><circle cx="5" cy="4" r="1.5" fill="currentColor"/><circle cx="11" cy="8" r="1.5" fill="currentColor"/><circle cx="7" cy="12" r="1.5" fill="currentColor"/></svg>
                            <div>
                                <div>Batch Tag Editor</div>
                                <div class="tool-dropdown-item-desc">Add, remove, or replace tags in bulk</div>
                            </div>
                        </button>
                        <button class="tool-dropdown-item" onclick="app.openDuplicateModal()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="10" height="12" rx="1"/><path d="M5 3V2a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1"/></svg>
                            <div>
                                <div>Find Duplicates</div>
                                <div class="tool-dropdown-item-desc">Detect and tag duplicate files</div>
                            </div>
                        </button>
                        <button class="tool-dropdown-item" onclick="app.openManagerModal()">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 2L7.5 3.5 9 5"/><path d="M7.5 3.5H12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2h1"/><path d="M5 8h6M5 11h4"/></svg>
                            <div>
                                <div>Manage Genres & Tags</div>
                                <div class="tool-dropdown-item-desc">Browse, rename & merge in bulk</div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="toolbar-helper-hint">Suggested flow: <strong>Smart Extract</strong> → <strong>Standardize</strong> → <strong>Optional cleanup</strong>.</div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Composer</th>
                            <th>Genre</th>
                            <th>Tags</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="export-section">
                <button class="btn btn-primary btn-action" onclick="app.exportCSV()">
                    <span class="btn-action-content">
                        <svg class="btn-action-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v10M4 8l4 4 4-4"/><path d="M2 13v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1"/></svg>
                        <span class="btn-action-text">
                            <span class="btn-action-label">Export Cleaned CSV</span>
                            <span class="btn-action-desc">Download updated library</span>
                        </span>
                    </span>
                </button>
                <button id="undoBtn" class="btn btn-secondary btn-action" onclick="app.undo()" disabled>
                    <span class="btn-action-content">
                        <svg class="btn-action-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h7a4 4 0 0 1 0 8H7"/><path d="M6 4L3 7l3 3"/></svg>
                        <span class="btn-action-text">
                            <span class="btn-action-label btn-tool-label">Undo</span>
                            <span class="btn-action-desc">Reverse last action</span>
                        </span>
                    </span>
                </button>
                <button class="btn btn-secondary btn-action" onclick="app.reset()">
                    <span class="btn-action-content">
                        <svg class="btn-action-icon" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 8a7 7 0 0 1 13.3-3M15 8a7 7 0 0 1-13.3 3"/><path d="M14.3 1v4h-4M1.7 15v-4h4"/></svg>
                        <span class="btn-action-text">
                            <span class="btn-action-label">Start Over</span>
                            <span class="btn-action-desc">Clear imported data</span>
                        </span>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <div class="app-footer-inner">
            <span class="footer-brand">TidyScore</span>
            <span class="footer-sep">&middot;</span>
            <span class="footer-version">v0.1.0-beta.1</span>
            <span class="footer-sep">&middot;</span>
            <span class="footer-global-count" hidden>Global cleaned count: <strong id="globalCleanedCountValue">—</strong></span>
            <span class="footer-sync-status" id="counterSyncStatus" hidden>Sync offline</span>
            <span>by <a href="https://mitchlyoncello.com" target="_blank" rel="noopener noreferrer" class="footer-link">Mitch Lyon</a></span>
        </div>
    </footer>

    <!-- Find & Replace Modal -->
    <div id="findReplaceModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Find & Replace</h3>
            <div class="form-group">
                <label class="form-label">Find</label>
                <input type="text" id="findText" class="form-input" placeholder="Text to find">
            </div>
            <div class="form-group">
                <label class="form-label">Replace with</label>
                <input type="text" id="replaceText" class="form-input" placeholder="Replacement text">
            </div>
            <div class="form-group">
                <label class="form-label">In field</label>
                <select id="replaceField" class="form-input">
                    <option value="composer">Composer</option>
                    <option value="title">Title</option>
                    <option value="genre">Genre</option>
                    <option value="tags">Tags</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.executeReplace()">Replace All</button>
            </div>
        </div>
    </div>

    <!-- Extraction Results Modal -->
    <div id="extractionModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Smart Extraction Results</h3>
            <p class="modal-desc" id="extractionDesc">
                Found <strong id="extractionCount">0</strong> composer suggestions.
            </p>
            <p class="modal-desc">
                <span id="extractionSelectedCount" class="modal-desc-accent"></span>
            </p>
            <div class="extraction-header">
                <input type="checkbox" id="selectAllExtractions" onchange="app.toggleSelectAllExtractions()" checked>
                <label for="selectAllExtractions" style="cursor: pointer; user-select: none;">Select All</label>
            </div>
            <div id="extractionResults" class="extraction-results"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeExtractionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.applyExtraction()">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- IMSLP Cleanup Modal -->
    <div id="imslpModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Clean IMSLP Titles</h3>
            <p class="modal-desc">
                Found <strong id="imslpCount">0</strong> IMSLP titles to clean.
                <span id="imslpSelectedCount" class="modal-desc-accent"></span>
            </p>
            <div class="extraction-header" style="margin-bottom: 4px;">
                <input type="checkbox" id="imslpAddLabel" onchange="app.toggleImslpLabel()" checked>
                <label for="imslpAddLabel" style="cursor: pointer; user-select: none;">Add (IMSLP) label to cleaned titles</label>
            </div>
            <div class="extraction-header">
                <input type="checkbox" id="selectAllImslp" onchange="app.toggleSelectAllImslp()" checked>
                <label for="selectAllImslp" style="cursor: pointer; user-select: none;">Select All</label>
            </div>
            <div id="imslpResults" class="extraction-results"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeImslpModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.applyImslpCleanup()">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- Export Summary Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 620px;">
            <h3 class="modal-title">Export Summary</h3>
            <p class="modal-desc" id="exportSummaryDesc"></p>
            <div id="exportSummaryList" class="extraction-results" style="max-height: 260px;"></div>
            <button class="diff-toggle" id="diffToggle" onclick="app.toggleDiffView()" style="display:none;">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><path d="M5 2l5 5-5 5"/></svg>
                <span id="diffToggleLabel">Show all changes</span>
            </button>
            <div id="diffContainer" class="diff-list" style="display:none;"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeExportModal()">Cancel</button>
                <button class="btn btn-primary btn-icon" onclick="app.doExport()">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v10M4 8l4 4 4-4"/><path d="M2 13v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1"/></svg>
                    Download CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Preview Modal (shared by Quick Clean, Standardize, Find & Replace) -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 620px;">
            <h3 class="modal-title" id="previewModalTitle">Preview Changes</h3>
            <p class="modal-desc" id="previewModalDesc"></p>
            <div class="extraction-header">
                <input type="checkbox" id="previewSelectAll" onchange="app.toggleAllPreviewItems()" checked>
                <label for="previewSelectAll" style="cursor: pointer; user-select: none;">Select All</label>
            </div>
            <div class="preview-list" id="previewList"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closePreviewModal()">Cancel</button>
                <button class="btn btn-primary" id="previewApplyBtn" onclick="app.applyPreviewChanges()">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- Batch Tag Editor Modal -->
    <div id="batchTagModal" class="modal">
        <div class="modal-content" style="max-width: 560px;">
            <h3 class="modal-title">Batch Tag Editor</h3>
            <p class="modal-desc" id="batchTagScope"></p>
            <div class="batch-tag-tabs">
                <button class="batch-tag-tab active" onclick="app.switchBatchTagMode('add')">Add</button>
                <button class="batch-tag-tab" onclick="app.switchBatchTagMode('remove')">Remove</button>
                <button class="batch-tag-tab" onclick="app.switchBatchTagMode('replace')">Replace</button>
            </div>

            <div id="batchTagAdd" class="batch-tag-pane active">
                <div class="batch-tag-input-row">
                    <input type="text" id="batchTagAddInput" placeholder="Enter tag to add..." onkeydown="if(event.key==='Enter')app.batchAddTag()">
                    <button class="btn btn-primary" onclick="app.batchAddTag()">Add Tag</button>
                </div>
            </div>

            <div id="batchTagRemove" class="batch-tag-pane">
                <p style="font-size:13px;color:var(--color-text-muted);margin-bottom:8px;">Click a tag to remove it from all target rows:</p>
                <div class="tag-chips" id="batchTagRemoveChips"></div>
            </div>

            <div id="batchTagReplace" class="batch-tag-pane">
                <div class="batch-tag-input-row">
                    <input type="text" id="batchTagReplaceFrom" placeholder="Find tag...">
                    <span style="display:flex;align-items:center;color:var(--color-text-muted);">&rarr;</span>
                    <input type="text" id="batchTagReplaceTo" placeholder="Replace with...">
                </div>
                <button class="btn btn-primary" onclick="app.batchReplaceTag()" style="width:100%;">Replace Tag</button>
            </div>

            <div class="modal-buttons" style="margin-top:16px;">
                <button class="btn btn-secondary" onclick="app.closeBatchTagEditor()">Close</button>
            </div>
        </div>
    </div>

    <!-- Genre Suggestion Modal -->
    <div id="genreSuggestModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Suggest Genre from Composer</h3>
            <p class="modal-desc">
                Found <strong id="genreSuggestCount">0</strong> rows where genre can be inferred from the composer.
                <span id="genreSuggestSelectedCount" class="modal-desc-accent"></span>
            </p>
            <div class="extraction-header">
                <input type="checkbox" id="selectAllGenreSuggestions" onchange="app.toggleAllGenreSuggestions()" checked>
                <label for="selectAllGenreSuggestions" style="cursor: pointer; user-select: none;">Select All</label>
            </div>
            <div id="genreSuggestResults" class="extraction-results"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeGenreSuggestModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.applyGenreSuggestions()">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- Tag Suggestion Modal -->
    <div id="tagSuggestModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Suggest Tags from Titles</h3>
            <p class="modal-desc">
                Found <strong id="tagSuggestCount">0</strong> rows with tag suggestions from title keywords.
                <span id="tagSuggestSelectedCount" class="modal-desc-accent"></span>
            </p>
            <div class="extraction-header">
                <input type="checkbox" id="selectAllTagSuggestions" onchange="app.toggleAllTagSuggestions()" checked>
                <label for="selectAllTagSuggestions" style="cursor: pointer; user-select: none;">Select All</label>
            </div>
            <div id="tagSuggestResults" class="extraction-results"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeTagSuggestModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.applyTagSuggestions()">Apply Selected</button>
            </div>
        </div>
    </div>

    <!-- Genre/Tag Manager Modal -->
    <div id="managerModal" class="modal">
        <div class="modal-content manager-modal-content">
            <h3 class="modal-title">Genre & Tag Manager</h3>
            <div class="manager-tabs">
                <button class="manager-tab active" id="managerTabGenres" onclick="app.switchManagerTab('genres')">Genres</button>
                <button class="manager-tab" id="managerTabTags" onclick="app.switchManagerTab('tags')">Tags</button>
            </div>
            <div class="manager-search-row">
                <input type="text" id="managerSearchInput" class="form-input" placeholder="Filter values..." oninput="app.filterManagerList()">
            </div>
            <div id="managerList" class="extraction-results manager-list"></div>
            <div class="manager-rename-row">
                <div class="manager-selected-info">
                    <span id="managerSelectedCount">0</span> selected
                </div>
                <input type="text" id="managerRenameInput" class="form-input manager-rename-input" placeholder="Rename selected to...">
                <button class="btn btn-primary" onclick="app.applyManagerRename()">Rename</button>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeManagerModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal" onclick="if(event.target===this)app.closeHelp()">
        <div class="modal-content help-modal-content">
            <h3 class="modal-title">How to Use TidyScore</h3>
            <div class="help-steps">
                <div class="help-step">
                    <div class="help-step-number">1</div>
                    <div class="help-step-body">
                        <div class="help-step-title">Export Your Metadata from forScore</div>
                        <ol class="help-step-list">
                            <li>Open <strong>forScore</strong>.</li>
                            <li>Tap the <strong>Backup</strong> menu (under the suitcase tools).</li>
                            <li>Tap the small <strong>"scroll" icon</strong> (the slightly hidden export button).</li>
                            <li>Choose <strong>Export</strong>.</li>
                            <li>Save the exported file to Files, iCloud, or wherever you can access it.</li>
                        </ol>
                    </div>
                </div>
                <div class="help-step">
                    <div class="help-step-number">2</div>
                    <div class="help-step-body">
                        <div class="help-step-title">Import the CSV into TidyScore</div>
                        <ol class="help-step-list">
                            <li>Open <strong>TidyScore</strong>.</li>
                            <li>Upload the CSV file you just exported.</li>
                            <li>Make your desired metadata edits or run your cleanup tools.</li>
                            <li>When finished, export the <strong>updated CSV</strong> from TidyScore.</li>
                        </ol>
                    </div>
                </div>
                <div class="help-step">
                    <div class="help-step-number">3</div>
                    <div class="help-step-body">
                        <div class="help-step-title">Import the Updated File Back into forScore</div>
                        <ol class="help-step-list">
                            <li>Return to <strong>forScore</strong>.</li>
                            <li>Under the music note button, select <strong>'Import'</strong>.</li>
                            <li>Select the updated CSV file you exported from TidyScore.</li>
                        </ol>
                        <div class="help-step-note">Don't worry if nothing appears to change immediately &mdash; that's normal.</div>
                    </div>
                </div>
                <div class="help-step">
                    <div class="help-step-number">4</div>
                    <div class="help-step-body">
                        <div class="help-step-title">Apply the Imported Metadata</div>
                        <ol class="help-step-list">
                            <li>Go back to the <strong>Backups</strong> screen.</li>
                            <li>Tap the <strong>"scroll" icon</strong> again.</li>
                            <li>Select <strong>Import</strong> this time.</li>
                            <li>Choose the file and confirm.</li>
                        </ol>
                    </div>
                </div>
            </div>
            <a href="https://docs.google.com/document/d/e/2PACX-1vQEVFozrRtt7usL06Ia6t7XY2WcAPXYQh9ml-zqVDgAk9yuA1gTERkWWYHryDBFj1GCTqk1ULqa32Mt/pub" target="_blank" rel="noopener noreferrer" class="help-guide-link">
                View full guide with screenshots &rarr;
            </a>
            <div class="help-shortcuts">
                <div class="help-shortcuts-title">Keyboard shortcuts</div>
                <table class="help-shortcuts-table">
                    <tbody>
                        <tr><td><kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>Z</kbd></td><td>Undo last change</td></tr>
                        <tr><td><kbd>Ctrl</kbd>/<kbd>⌘</kbd> + <kbd>F</kbd></td><td>Focus search bar</td></tr>
                        <tr><td><kbd>Esc</kbd></td><td>Close active dialog</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="app.closeHelp()">Close</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal" onclick="if(event.target===this)app.closeSettingsModal()">
        <div class="modal-content" style="max-width: 760px;">
            <h3 class="modal-title">Settings</h3>
            <p class="modal-desc">Adjust composer formatting and alias-library behavior for cleanup tools.</p>
            <div class="form-group">
                <label class="form-label" for="settingsComposerNameDisplayFormat">Composer display format</label>
                <select id="settingsComposerNameDisplayFormat" class="form-input">
                    <option value="last_first">Last, First</option>
                    <option value="first_last">First Last</option>
                    <option value="preserve">Preserve input</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label class="form-label" for="settingsComposerLibraryMode">Composer alias library</label>
                <select id="settingsComposerLibraryMode" class="form-input">
                    <option value="builtin">Built-in aliases only</option>
                    <option value="builtin_plus_custom">Built-in + custom aliases</option>
                </select>
            </div>
            <div class="settings-advanced">
                <div class="settings-advanced-title">Advanced composer library edits</div>
                <div class="settings-advanced-desc">Define alias mappings and blacklist entries. Alias keys are normalized to lowercase + trimmed on input and save.</div>

                <div class="form-group" style="margin-bottom:14px;">
                    <label class="form-label">Editable alias table (alias key → canonical composer)</label>
                    <div id="settingsAliasTable" class="settings-kv-table"></div>
                    <div class="settings-helper-row">
                        <button class="btn btn-secondary" type="button" onclick="app.addComposerAliasRow()">+ Add alias mapping</button>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <label class="form-label">Editable blacklist list (alias values to suppress)</label>
                    <div id="settingsBlacklistTable" class="settings-kv-table"></div>
                    <div class="settings-helper-row">
                        <button class="btn btn-secondary" type="button" onclick="app.addComposerBlacklistRow()">+ Add blacklist entry</button>
                    </div>
                </div>

                <div id="settingsComposerWarnings" class="settings-warning-box" style="display:none;"></div>
            </div>

            <div class="settings-danger-zone">
                <button class="btn btn-secondary" type="button" onclick="app.resetComposerSettingsToDefaults()">Reset composer settings to defaults</button>
            </div>
            <div class="modal-buttons">
                <button id="settingsCancelBtn" class="btn btn-secondary" onclick="app.closeSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveSettingsFromModal()">Save settings</button>
            </div>
        </div>
    </div>

    <div id="duplicateModal" class="modal" onclick="if(event.target===this)app.closeDuplicateModal()">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-title">Find Duplicates</h3>
            <p class="modal-desc">
                Because CSV imports cannot delete PDFs from your iPad, selecting items here will add an
                <strong>"_Duplicate_Delete_Me"</strong> tag to them. After importing to forScore, filter by
                this tag and delete the files manually.
            </p>
            <div class="extraction-header">
                <input type="checkbox" id="dupSelectAll" onchange="app.toggleDupSelectAll()">
                <label for="dupSelectAll">Select All</label>
                <span id="dupSelectedCount" style="margin-left:auto; font-size:12px; color:var(--color-text-muted);"></span>
            </div>
            <div id="duplicateResults" class="extraction-results" style="max-height: 500px;"></div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="app.closeDuplicateModal()">Cancel</button>
                <button id="dupApplyBtn" class="btn btn-primary" onclick="app.applyDuplicateTags()">Tag Selected as '_Duplicate_Delete_Me'</button>
            </div>
        </div>
    </div>

        <script type="module">
        import app from './src/main.js';
        window.app = app;
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>
</body>
</html>
